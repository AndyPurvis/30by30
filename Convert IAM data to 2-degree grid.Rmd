---
title: "Convert IAM data to 2-degree grid"
author: "Andy Purvis"
date: "07/02/2021"
output:
  pdf_document:
    df_print: kable
    toc: true
    toc_depth: 2
    number_sections: true
  html_document: 
    df_print: paged
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Converting IAM data into 2-degree grid
## Source of data
These IAM outputs were downloaded from https://drive.google.com/drive/folders/1k6mVe8rQc29dh4MZkxhPCDuhp38dV_dF on 2021-02-03, and are described in two emails from Anthony Waldron. The unzipped data, in its original folder structure, is within the "/data" folder.

## Load the required libraries and functions
The functions are, for now, a straight copy of the code used in the analysis for the Urgency of Biodiversity Loss.
```{r, load, echo=FALSE, cache=TRUE}
start.time <- Sys.time()
library(raster)
library(scales)
library(abind)
library(gplots)
library(colorspace)
library(ncdf4) # package for netcdf manipulation, suggested by https://rpubs.com/boyerag/297592
library(rgdal) # package for geospatial analysis, suggested by https://rpubs.com/boyerag/297592
library(ggplot2) # package for plotting, suggested by https://rpubs.com/boyerag/297592
library(ncdf.tools) # https://rdrr.io/cran/ncdf.tools/man/plotDatacube.html
source("00_functions.R")
```
# Read an example data set
As an example, I will read one of the action scenarios from MAgPIE. MAgPIE is the IAM whose output I am most likely to be able to use easily, but the reference scenario would be a bad choice as not all land uses would be represented.

```{r, read_example, echo=FALSE, cache=TRUE}
iam_file <- "data/IAM outputs for 30 by 30 scenarios/MAGPIE/BendingTheCurve30by30-LCproj-MAgPIE-RCPref_SSP2_GDN-06Feb2020_FinalMask.nc"

crop_other <- aggregate(brick(iam_file, 
                 varname="LC_area_share", lvar = 3, nl=19, level=1), 
                 fact = 4, fun = mean)

crop_bioen <- aggregate(brick(iam_file, 
                 varname="LC_area_share", lvar = 3, nl=19, level=2), 
                 fact = 4, fun = mean)

restored <- aggregate(brick(iam_file, 
                 varname="LC_area_share", lvar = 3, nl=19, level=6), 
                 fact = 4, fun = mean)

plot(crop_other, 1)
plot(crop_bioen, 1)
plot(restored)

plot(seq(2010,2100,5), as.numeric(cellStats(crop_bioen, sum)))

eg_data <- brick("data/IAM outputs for 30 by 30 scenarios/MAGPIE/BendingTheCurve30by30-LCproj-MAgPIE-RCPref_SSP2_GDN-06Feb2020_FinalMask.nc")


eg_stack <- stack("data/IAM outputs for 30 by 30 scenarios/MAGPIE/BendingTheCurve30by30-LCproj-MAgPIE-RCPref_SSP2_GDN-06Feb2020_FinalMask.nc",level=10)
plot(eg_stack, 1)
```