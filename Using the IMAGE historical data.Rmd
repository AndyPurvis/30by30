---
title: "Using the IMAGE historical data"
author: "Andy Purvis"
date: "14/02/2021"
output:
  pdf_document:
    df_print: kable
    toc: true
    toc_depth: 2
    number_sections: true
  html_document: 
    df_print: paged
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# using the IMAGE historical data

David LeClere has shared with me a 30-by-30-compatible historical land-use netCDF going back to 1970. This is appealing for two main reasons. First, IMAGE provides the best match to the LUH2 data in 2010. Second, 1970 is a full half-life before the present, de-emphasizing artifacts caused by having to harmonize incongruent land-use trajectories.

This code has the following objectives:

1. Read in and examine the IMAGE data

2. Compare IMAGE with LUH2 for each time step from 1970 to 2015, hoping that 1970 will not be very much worse than 2015; and using the range-size rarity layer when making these comparisons

3. 
```{r, load, echo=FALSE, cache=}
start.time <- Sys.time()
library(raster)
library(scales)
library(abind)
library(gplots)
library(colorspace)
library(maps)
library(ncdf4) # package for netcdf manipulation, suggested by https://rpubs.com/boyerag/297592
library(rgdal) # package for geospatial analysis, suggested by https://rpubs.com/boyerag/297592
library(ggplot2) # package for plotting, suggested by https://rpubs.com/boyerag/297592
source("00_functions.R")
source("convert_iam_data.R")
```

## Reading the file in and examining the metadata
The data are on an 0.5$^\circ$ grid, and there are four years -- 1970, 1980, 1990 and 2000. There are 12 land-use classes. As well as the stack containing the area shares of each land-use class, there is a single raster of pixel (cell) area. The structure is therefore not exactly the same as the IAM data used previously: there are fewer (as well as different) years, but also the internal organisation is sufficiently different that the years with data could not be identified using the same code as for those files.
```{r read-and-examine, echo=FALSE}
image <- brick("data/ForAndy/BendingTheCurveFT-LCproj-IMAGE-history-R2_wabn_31Jan2020_FinalMask.nc")
print(image)
cat("\nYears with land-use data:\n")
print(names(image)) # Which years
```

## Estimating ENA for each of the four layers and plotting the earliest (1970)

```{r, get-ENA-for-IMAGE, echo=FALSE, cache=TRUE}
which_bii <- "BII_humdom0"
iam_file <- "data/ForAndy/BendingTheCurveFT-LCproj-IMAGE-history-R2_wabn_31Jan2020_FinalMask.nc"
ena_file <- "output/ena/ENA-IMAGE-1970-2000.nc"
pdf_file <- "reports/Converting IAMs to ENA/ENA-IMAGE-1970-2000.pdf"
ena_image_1970 <- convert_iam_data(iam_file, which_bii, ena_file, pdf_file, yb=1970, ye=2000, ys=10)
plot(ena_image_1970)

```



