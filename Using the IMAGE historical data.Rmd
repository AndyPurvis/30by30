---
title: "Using the IMAGE historical data"
author: "Andy Purvis"
date: "14/02/2021"
output:
  html_document: 
    df_print: paged
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
  pdf_document:
    df_print: kable
    toc: true
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# using the IMAGE historical data

David LeClere has shared with me a 30-by-30-compatible historical land-use netCDF going back to 1970. This is appealing for two main reasons. First, IMAGE provides the best match to the LUH2 data in 2010. Second, 1970 is a full half-life before the present, de-emphasizing artifacts caused by having to harmonize incongruent land-use trajectories.

This code has the following objectives:

1. Read in and examine the IMAGE data

2. Compare IMAGE with LUH2 for each time step from 1970 to 2015, hoping that 1970 will not be very much worse than 2015; and using the range-size rarity layer when making these comparisons

3. 
```{r, load, echo=FALSE, cache=FALSE}
library(checkpoint)
checkpoint("2021-02-16")

start.time <- Sys.time()
library(raster)
library(scales)
library(abind)
library(gplots)
library(colorspace)
library(maps)
library(ncdf4) # package for netcdf manipulation, suggested by https://rpubs.com/boyerag/297592
library(rgdal) # package for geospatial analysis, suggested by https://rpubs.com/boyerag/297592
library(ggplot2) # package for plotting, suggested by https://rpubs.com/boyerag/297592
source("00_functions.R")
source("convert_iam_data.R")
```
## Read in range-size rarity as this shows whether mismatches might matter
Difficulties harmonizing the data on effective natural area matter more in regions with considerable range-size rarity, as these are the places where extinction debt could be artificially inflated by mismatches.

```{r, range-size-rarity, echo=FALSE, cache=TRUE}
rsr <- raster("output/rsr2.nc") # Generated as part of De Palma et al. (in prep.), as the sum of the 44 grid cells per 2-degree cell
rsr_rescaled <- rsr/cellStats(rsr, "mean")
plot(rsr_rescaled, main="Relative range-size rarity per 2-degree grid cell in 2015")
map(add=TRUE)
```

## Reading the file in and examining the metadata
The data are on an 0.5$^\circ$ grid, and there are four years -- 1970, 1980, 1990 and 2000. There are 12 land-use classes. As well as the stack containing the area shares of each land-use class, there is a single raster of pixel (cell) area. The structure is therefore not exactly the same as the IAM data used previously: there are fewer (as well as different) years, but also the internal organisation is sufficiently different that the years with data could not be identified using the same code as for those files.
```{r read-and-examine, echo=FALSE}
image <- brick("data/ForAndy/BendingTheCurveFT-LCproj-IMAGE-history-R2_wabn_31Jan2020_FinalMask.nc", level=3)
print(image)
cat("\nYears with land-use data:\n")
print(unlist(image@z)) # Which years
```

## Estimating ENA for each of the four layers (and plotting the earliest (no maps produced)

```{r, get-ENA-for-IMAGE, echo=FALSE, cache=TRUE}
which_bii <- "BII_humdom0"
iam_file <- "data/ForAndy/BendingTheCurveFT-LCproj-IMAGE-history-R2_wabn_31Jan2020_FinalMask.nc"
ena_file <- "output/ena/ENA-IMAGE-1970-2000.nc"
pdf_file <- "reports/Converting IAMs to ENA/ENA-IMAGE-1970-2000.pdf"
ena_image_1970 <- convert_iam_data(iam_file, which_bii, ena_file, pdf_file, yb=1970, ye=2000, ys=10)
cell_areas <- aggregate(raster(iam_file, varname = "pixel_area"), fact=4, fun=sum)

```
## Compare IMAGE at 1970, 1980, 1990 and 2000 with corresponding LUH2 data
The results of this comparison are extremely pleasing. First, the agreement is best in 1970, which is the preferred year on which to harmonize for conceptual reasons as well. Second, the agreement is improved when cells are weighted by their range-size rarity, meaning that the disagreements matter less than they might have done.

```{r, compare-with-LUH2, echo=FALSE, cache=TRUE}
ena <- stack("output/ena/ENA-IMAGE-1970-2000.nc")
luh2 <- raster("output/ENA_LUH2_1970.nc")
luh2 <- addLayer(luh2, raster("output/ENA_LUH2_1980.nc"))
luh2 <- addLayer(luh2, raster("output/ENA_LUH2_1990.nc"))
luh2 <- addLayer(luh2, raster("output/ENA_LUH2_2000.nc"))

years <- c(1970,1980,1990,2000)
for (i in 1:4){
  plot(subset(luh2, i) - subset(ena, i), main = paste("LUH2 - IMAGE:", years[i]))
  map(add=TRUE)
  plot(subset(luh2, i), subset(ena, i), ylab=paste("IMAGE", years[i]), xlab=paste("LUH2", years[i]))
  abline(a=0,b=1,col="red")
  lv <- getValues(subset(luh2,i))
  iv <- getValues(subset(ena, i))
  li <- !is.na(lv*iv)
  text(0, 4.5, paste("r =", round(cor(lv[li], iv[li]), 3)), adj=0)
  
  m1 <- lm(iv[li] ~ lv[li], weights=getValues(rsr_rescaled)[li])
  text(0, 4, paste("weighted r =", round(sqrt(summary(m1)$r.squared), 3)), adj=0)

}
```


## Produce annual LUH2 data and rescale to match IMAGE data
```{r, rescale-LUH2, echo=FALSE, cache=TRUE}
if (file.exists("output/historic_annual_area.Rds")){
  historic_annual_area <- readRDS("output/historic_annual_area.Rds")
}else{
  source("01_produce_historical_area.R")
}

# Summarise landscape change
global_effective_area <- apply(historic_annual_area, MARGIN=3, sum, na.rm=TRUE)
plot(global_effective_area ~ c(850:2020), ylab="Global natural habitat", xlab="Year", type="l",
     main="Global effective area from LUH2 harmonized with IMAGE in 1970", sub="Note rise after Black Death")
abline(v=1970, col="red", lty=2)

# Check for a discontinuity in rate of change - i.e., in the sum of absolute year-to-year changes across grid cells
turnover <- rep(NA, 2020-850)
for (i in 1:(2020-850)){
  diff <- abs(historic_annual_area[,,i+1] - historic_annual_area[,,i])
  turnover[i] <- sum(diff, na.rm=TRUE)
}
plot(turnover ~ c(850:2019), type="l", ylab="Gross land-use change",
     main = "Land-use change between successive years") #No artifactual spike in the recent past or near future, so OK
abline(v=1970, col="red", lty=2)

```
