---
title: "Using the IMAGE historical data"
author: "Andy Purvis"
date: "14/02/2021"
output:
  html_document: 
    df_print: paged
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
  pdf_document:
    df_print: kable
    toc: true
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# using the IMAGE historical data

David LeClere has shared with me a 30-by-30-compatible historical land-use netCDF going back to 1970. This is appealing for two main reasons. First, IMAGE provides the best match to the LUH2 data in 2010. Second, 1970 is a full half-life before the present, de-emphasizing artifacts caused by having to harmonize incongruent land-use trajectories.

This code has the following objectives:

1. Read in and examine the IMAGE data

2. Compare IMAGE with LUH2 for each time step from 1970 to 2015, hoping that 1970 will not be very much worse than 2015; and using the range-size rarity layer when making these comparisons

3. 
```{r, load, echo=FALSE, cache=}
start.time <- Sys.time()
library(raster)
library(scales)
library(abind)
library(gplots)
library(colorspace)
library(maps)
library(ncdf4) # package for netcdf manipulation, suggested by https://rpubs.com/boyerag/297592
library(rgdal) # package for geospatial analysis, suggested by https://rpubs.com/boyerag/297592
library(ggplot2) # package for plotting, suggested by https://rpubs.com/boyerag/297592
source("00_functions.R")
source("convert_iam_data.R")
```

## Reading the file in and examining the metadata
The data are on an 0.5$^\circ$ grid, and there are four years -- 1970, 1980, 1990 and 2000. There are 12 land-use classes. As well as the stack containing the area shares of each land-use class, there is a single raster of pixel (cell) area. The structure is therefore not exactly the same as the IAM data used previously: there are fewer (as well as different) years, but also the internal organisation is sufficiently different that the years with data could not be identified using the same code as for those files.
```{r read-and-examine, echo=FALSE}
image <- brick("data/ForAndy/BendingTheCurveFT-LCproj-IMAGE-history-R2_wabn_31Jan2020_FinalMask.nc")
print(image)
cat("\nYears with land-use data:\n")
print(names(image)) # Which years
```

## Estimating ENA for each of the four layers and plotting the earliest (1970)

```{r, get-ENA-for-IMAGE, echo=FALSE, cache=TRUE}
which_bii <- "BII_humdom0"
iam_file <- "data/ForAndy/BendingTheCurveFT-LCproj-IMAGE-history-R2_wabn_31Jan2020_FinalMask.nc"
ena_file <- "output/ena/ENA-IMAGE-1970-2000.nc"
pdf_file <- "reports/Converting IAMs to ENA/ENA-IMAGE-1970-2000.pdf"
ena_image_1970 <- convert_iam_data(iam_file, which_bii, ena_file, pdf_file, yb=1970, ye=2000, ys=10)
plot(ena_image_1970)
map(add=TRUE)

```
## Compare with LUH2 data

```{r, compare-with-LUH2, echo=FALSE, cache=TRUE}
luh2_1970 <- raster("output/ENA_LUH2_1970.nc")
plot(luh2_1970 - ena_image_1970, main = "1970: LUH2 - IMAGE")
map(add=TRUE)
plot(luh2_1970, ena_image_1970, ylab="IMAGE 1970", xlab="LUH2 1970")
abline(a=0,b=1, col="red")
l70 <- getValues(luh2_1970)
i70 <- getValues(ena_image_1970)
li <- !is.na(l70*i70)
text(0, 4.5, paste("r =", round(cor(l70[li], i70[li]), 3)), adj=0)
```
## Read range size rarity raster in from IUCN and sum within 2$^\circ$ grid cells
Range-size rarity is on a grid with cells that are 5km square at the equator, so are not strictly nested within the 2$^\circ$ grid cells of the land-use data. The data are therefore resampled (actually done on log-transformed data because range-size rarity is extremely skewed) into a $\frac{1}{22}$$^\circ$ grid. Then aggregate is used to sum the 44 x 44 antilogged values within each 2$^\circ$ grid cell. This range-size rarity layer is taken as a proxy for the relative numbers of endemic species within each grid cell in the present day.

```{r, range-size-rarity, echo=FALSE, cache=TRUE}
log_rsr <- log(raster("data/RSR_all.tif"))
extract(log_rsr, cbind(0,0))
id_log_rsr = which.max(log_rsr)
print(xyFromCell(log_rsr,id_log_rsr))
cell_area_raster <- raster("data/cell-area.tif")
nested_raster <- disaggregate(cell_area_raster, fact=44)
nested_log_rsr <- raster::resample(log_rsr, nested_raster)
extract(nested_log_rsr, cbind(0,0))
id_nested_log_rsr = which.max(nested_log_rsr)
print(xyFromCell(nested_rsr,id_nested_log_rsr))
rsr <- aggregate(nested_log_rsr, fact=44)
extract(rsr, cbind(0,0))
id_rsr = which.max(rsr)
print(xyFromCell(rsr,id_rsr))
plot(rsr)
plot(log(rsr), main="Range-size rarity summed within 2-degree grid cells")
rsr_rescaled <- rsr/cellStats(rsr, mean) #Converts to a mean of 1
rsr_array <- as.array(rsr_rescaled) #Convert to array as S_t is an array
```


## Read in and rescale whole of LUH2 raster stack
```{r, rescale-LUH2, echo=FALSE, cache=TRUE}

luh2 <- stack("output/ENA_LUH2.nc")
```